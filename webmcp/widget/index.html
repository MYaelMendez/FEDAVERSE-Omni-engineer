<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebMCP Terminal</title>

  <!-- xterm.js from CDN (no build step required) -->
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>

  <style>
    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Segoe UI', system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* ── Header ── */
    header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: #252526;
      border-bottom: 1px solid #3c3c3c;
      flex-shrink: 0;
    }
    header h1 { margin: 0; font-size: 1rem; font-weight: 600; color: #cccccc; }

    #status-badge {
      margin-left: auto;
      padding: 2px 10px;
      border-radius: 99px;
      font-size: 0.75rem;
      font-weight: 600;
      background: #3c3c3c;
      color: #858585;
      transition: background 0.2s, color 0.2s;
    }
    #status-badge.ready      { background: #163832; color: #4ec994; }
    #status-badge.computing  { background: #1e3a5f; color: #569cd6; }
    #status-badge.governance { background: #4a2e0a; color: #e5a038; }
    #status-badge.error      { background: #3e1515; color: #f44747; }

    /* ── Terminal container ── */
    #terminal-container {
      flex: 1;
      overflow: hidden;
      padding: 4px;
    }

    /* ── Input bar ── */
    #input-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #252526;
      border-top: 1px solid #3c3c3c;
      flex-shrink: 0;
    }
    #input-bar span { color: #4ec994; font-family: monospace; font-size: 0.9rem; }
    #cmd-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: #d4d4d4;
      font-family: monospace;
      font-size: 0.9rem;
      caret-color: #d4d4d4;
    }
    #run-btn {
      padding: 4px 14px;
      border: 1px solid #569cd6;
      border-radius: 4px;
      background: transparent;
      color: #569cd6;
      cursor: pointer;
      font-size: 0.85rem;
      transition: background 0.15s;
    }
    #run-btn:hover { background: #1e3a5f; }
    #run-btn:disabled { opacity: 0.4; cursor: default; }

    /* ── Governance modal ── */
    #gov-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    #gov-overlay.visible { display: flex; }

    #gov-modal {
      background: #252526;
      border: 1px solid #f44747;
      border-radius: 8px;
      padding: 24px 28px;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    }
    #gov-modal h2 {
      margin: 0 0 12px;
      font-size: 1rem;
      color: #f44747;
    }
    .gov-field { margin: 8px 0; font-size: 0.85rem; }
    .gov-field label { color: #858585; }
    .gov-field .val { color: #d4d4d4; font-family: monospace; word-break: break-all; }
    .gov-field .score { font-weight: 700; color: #e5a038; }

    #gov-actions { display: flex; gap: 12px; margin-top: 20px; }
    #gov-approve-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 4px;
      background: #163832;
      color: #4ec994;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.15s;
    }
    #gov-approve-btn:hover { background: #1e4d42; }
    #gov-abort-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 4px;
      background: #3e1515;
      color: #f44747;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.15s;
    }
    #gov-abort-btn:hover { background: #5a2020; }
  </style>
</head>
<body>

<!-- Header -->
<header>
  <h1>⚡ WebMCP Terminal</h1>
  <span id="status-badge">connecting…</span>
</header>

<!-- xterm.js terminal -->
<div id="terminal-container"></div>

<!-- Command input bar -->
<div id="input-bar">
  <span>$&nbsp;</span>
  <input id="cmd-input" type="text" placeholder="Enter command…" autocomplete="off" spellcheck="false" />
  <button id="run-btn">Run</button>
</div>

<!-- Governance approval modal -->
<div id="gov-overlay" role="dialog" aria-modal="true" aria-labelledby="gov-title">
  <div id="gov-modal">
    <h2 id="gov-title">⚠️ Governance Approval Required</h2>
    <div class="gov-field">
      <label>Command: </label>
      <span class="val" id="gov-command"></span>
    </div>
    <div class="gov-field">
      <label>Risk score: </label>
      <span class="score" id="gov-score"></span>
      <span id="gov-reason" style="color:#858585;margin-left:6px;"></span>
    </div>
    <p style="font-size:0.8rem;color:#858585;margin:12px 0 0;">
      Review the command carefully. Approve only if you trust its effects.
    </p>
    <div id="gov-actions">
      <button id="gov-approve-btn">✓ Approve &amp; Run</button>
      <button id="gov-abort-btn">✗ Abort</button>
    </div>
  </div>
</div>

<script>
// ── xterm.js setup ────────────────────────────────────────────────────────
const term = new Terminal({
  cursorBlink: true,
  theme: {
    background: '#1e1e1e',
    foreground: '#d4d4d4',
    cursor: '#d4d4d4',
    selectionBackground: '#264f78',
  },
  fontFamily: "'Cascadia Code', 'Fira Code', 'Courier New', monospace",
  fontSize: 14,
  convertEol: true,
});
const fitAddon = new FitAddon.FitAddon();
term.loadAddon(fitAddon);
term.open(document.getElementById('terminal-container'));
fitAddon.fit();
window.addEventListener('resize', () => fitAddon.fit());

term.writeln('\x1b[1;32mWebMCP Terminal\x1b[0m – connecting to gateway…');

// ── Status badge ─────────────────────────────────────────────────────────
const statusBadge = document.getElementById('status-badge');
const STATUS_CLASSES = ['ready', 'computing', 'governance', 'error'];
function setStatus(label) {
  statusBadge.textContent = label;
  STATUS_CLASSES.forEach(c => statusBadge.classList.remove(c));
  const cls = label.toLowerCase().replace(/[^a-z]/g, '');
  if (STATUS_CLASSES.includes(cls)) statusBadge.classList.add(cls);
}

// ── Request-id counter ───────────────────────────────────────────────────
let _reqCounter = 0;
function nextId() { return ++_reqCounter; }

// ── Pending governance data ──────────────────────────────────────────────
let pendingGov = null; // { command, approvalToken }

// ── WebSocket ─────────────────────────────────────────────────────────────
const WS_URL = 'ws://127.0.0.1:8080';
let ws = null;

function connect() {
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    setStatus('ready');
    term.writeln('\x1b[32mConnected to gateway.\x1b[0m\r\n');
    cmdInput.disabled = false;
    runBtn.disabled   = false;
    cmdInput.focus();
  };

  ws.onclose = () => {
    setStatus('error');
    term.writeln('\r\n\x1b[31mDisconnected from gateway. Retrying in 3 s…\x1b[0m');
    cmdInput.disabled = true;
    runBtn.disabled   = true;
    setTimeout(connect, 3000);
  };

  ws.onerror = () => {
    setStatus('error');
  };

  ws.onmessage = (ev) => {
    let msg;
    try { msg = JSON.parse(ev.data); } catch { return; }
    handleMessage(msg);
  };
}

connect();

// ── Message handling ──────────────────────────────────────────────────────
function handleMessage(msg) {
  // Streaming output notification
  if (msg.method === 'notifications/terminal/output') {
    term.write(msg.params.chunk);
    return;
  }

  // Final response
  if (msg.result !== undefined) {
    const r = msg.result;

    if (r.is_governance_required) {
      // Show governance modal
      pendingGov = { command: r.command, approvalToken: r.approvalToken };
      document.getElementById('gov-command').textContent = r.command;
      document.getElementById('gov-score').textContent   = r.risk_score + ' / 10';
      document.getElementById('gov-reason').textContent  = '(' + r.risk_reason + ')';
      govOverlay.classList.add('visible');
      setStatus('governance');
      return;
    }

    if (r.done) {
      const code = r.exitCode;
      if (code === 0) {
        term.writeln('\r\n\x1b[32m[exit 0]\x1b[0m');
      } else {
        term.writeln(`\r\n\x1b[31m[exit ${code}]\x1b[0m`);
      }
      setStatus('ready');
      cmdInput.disabled = false;
      runBtn.disabled   = false;
      cmdInput.focus();
      return;
    }
  }

  if (msg.error) {
    term.writeln(`\r\n\x1b[31mError ${msg.error.code}: ${msg.error.message}\x1b[0m`);
    setStatus('ready');
    cmdInput.disabled = false;
    runBtn.disabled   = false;
    cmdInput.focus();
  }
}

// ── Run a command ─────────────────────────────────────────────────────────
function runCommand(command, approved, approvalToken) {
  const id = nextId();
  const args = { command };
  if (approved)       args.approved      = true;
  if (approvalToken)  args.approvalToken = approvalToken;

  const req = {
    jsonrpc: '2.0',
    id,
    method: 'tools/call',
    params: { name: 'terminal.run', arguments: args },
  };

  term.writeln(`\x1b[1;33m$ ${command}\x1b[0m`);
  setStatus('computing');
  cmdInput.disabled = true;
  runBtn.disabled   = true;
  ws.send(JSON.stringify(req));
}

// ── Input bar ─────────────────────────────────────────────────────────────
const cmdInput = document.getElementById('cmd-input');
const runBtn   = document.getElementById('run-btn');

cmdInput.disabled = true;
runBtn.disabled   = true;

runBtn.addEventListener('click', submitCommand);
cmdInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') submitCommand();
});

function submitCommand() {
  const cmd = cmdInput.value.trim();
  if (!cmd || !ws || ws.readyState !== WebSocket.OPEN) return;
  cmdInput.value = '';
  runCommand(cmd, false, null);
}

// ── Governance modal ──────────────────────────────────────────────────────
const govOverlay    = document.getElementById('gov-overlay');
const govApproveBtn = document.getElementById('gov-approve-btn');
const govAbortBtn   = document.getElementById('gov-abort-btn');

govApproveBtn.addEventListener('click', () => {
  if (!pendingGov) return;
  govOverlay.classList.remove('visible');
  runCommand(pendingGov.command, true, pendingGov.approvalToken);
  pendingGov = null;
});

govAbortBtn.addEventListener('click', () => {
  govOverlay.classList.remove('visible');
  term.writeln('\r\n\x1b[33m[Command aborted by user]\x1b[0m');
  setStatus('ready');
  cmdInput.disabled = false;
  runBtn.disabled   = false;
  cmdInput.focus();
  pendingGov = null;
});
</script>
</body>
</html>
